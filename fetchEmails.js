const Imap = require('imap');

// Configuration IMAP pour Gmail
const imapConfig = {
  user: '',
  password: 'Anaoussamaaouad1998@',
  host: 'imap.gmail.com',
  port: 993, // Port IMAPS
  tls: { rejectUnauthorized: false } // Désactiver la vérification du certificat
};


// Créez une nouvelle instance IMAP
const imap = new Imap(imapConfig);

// Fonction pour se connecter à Gmail et récupérer des emails
function fetchEmails() {
  imap.connect(); // Connexion au serveur IMAP

  imap.once('ready', () => {
    imap.openBox('INBOX', true, (err, box) => {
      if (err) {
        console.error('Erreur lors de l\'ouverture de la boîte de réception:', err);
        return;
      }

      // Récupération des derniers emails
      const fetchOptions = {
        bodies: ['HEADER.FIELDS (FROM TO SUBJECT DATE)'],
        struct: true,
        markSeen: false,
        maxMessages: 10, // Nombre maximal d'emails à récupérer
      };

      const emailData = [];

      const fetch = imap.seq.fetch('1:*', fetchOptions);

      fetch.on('message', (msg, seqno) => {
        msg.on('body', (stream, info) => {
          let buffer = '';
          stream.on('data', chunk => {
            buffer += chunk.toString('utf8');
          });
          stream.on('end', () => {
            try {
              const email = Imap.parseHeader(buffer);
              emailData.push(email);
            } catch (error) {
              console.error('Erreur lors de l\'analyse de l\'en-tête de l\'email:', error);
            }
          });
        });
      });

      fetch.once('end', () => {
        console.log('Emails récupérés avec succès:');
        console.log(emailData);
        imap.end(); // Fermeture de la connexion IMAP
      });
    });
  });

  imap.once('error', err => {
    console.error('Erreur IMAP:', err);
  });

  imap.once('end', () => {
    console.log('Déconnexion IMAP');
  });
}

// Appel de la fonction pour récupérer les emails
fetchEmails();
